<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">

    <link rel="manifest" href="manifest.json">

    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PING-PONG DB PRO</title> 

    <style>
        :root { --primary: #2e7d32; --secondary: #1976d2; --danger: #d32f2f; --bg: #f8f9fa; --card-bg: #ffffff; --btn-gray: #607d8b; }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg); margin: 0; padding: 10px; color: #333; line-height: 1.4; }

        /* === ì¸íŠ¸ë¡œ ë ˆì´ì–´ (í•´ìƒë„ ìœ ì§€ ë° í˜ì´ë“œ íš¨ê³¼) === */
        #intro-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #ffffff; display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 99999; opacity: 1; transition: opacity 0.8s ease-in-out;
        }
        .intro-img-container {
            width: 85%; max-width: 450px;
            display: flex; justify-content: center; align-items: center;
        }
        .intro-img { 
            width: 100%; height: auto; border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            /* ì›ë³¸ í•´ìƒë„ ë³´ì¡´ì„ ìœ„í•œ ë Œë”ë§ ì˜µì…˜ */
            image-rendering: -webkit-optimize-contrast;
            object-fit: contain;
        }
        .intro-text { 
            margin-top: 25px; font-size: 15px; color: #666; font-weight: 600; 
            letter-spacing: -0.5px; animation: blink 1.5s infinite; 
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* === ì›ë³¸ ìŠ¤íƒ€ì¼ ìœ ì§€ === */
        .container { max-width: 500px; margin: auto; background: white; padding: 15px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .header-container { margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; display: flex; flex-direction: column; }
        .header-title { color: var(--primary); margin: 0; font-size: 1.3em; font-weight: 800; text-align: center; width: 100%; }
        .header-subtitle { font-size: 9px; color: #bbb; font-weight: normal; align-self: flex-end; margin-top: 4px; }
        .box { background: var(--card-bg); padding: 15px; border-radius: 18px; margin-bottom: 12px; border: 1px solid #eaeaea; }
        .flex-row { display: flex; gap: 6px; margin-bottom: 10px; align-items: flex-start; }
        .input-group { flex: 1; display: flex; flex-direction: column; }
        .filter-label { font-size: 10px; font-weight: bold; color: #888; margin-bottom: 3px; padding-left: 2px; }
        select, input { padding: 8px; border-radius: 10px; border: 1px solid #ddd; font-size: 13px; width: 100%; box-sizing: border-box; height: 40px; }
        button { border: none; border-radius: 12px; padding: 12px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; font-size: 14px; }
        .btn-blue { background-color: var(--secondary); color: white; }
        .btn-orange { background-color: #ff9800; color: white; margin-top: 8px; }
        .btn-red { background-color: var(--danger); color: white; margin-top: 15px; font-size: 11px; padding: 6px; opacity: 0.7; }
        .switch-container { display: flex; align-items: center; justify-content: space-between; background: #eee; padding: 4px; border-radius: 12px; margin-bottom: 8px; }
        .switch-btn { flex: 1; text-align: center; padding: 8px; font-size: 12px; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .switch-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .player-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; max-height: 300px; overflow-y: auto; padding: 5px; }
        .player-item { background: #f9f9f9; padding: 8px 12px; border-radius: 10px; border: 1px solid #eee; font-size: 13px; display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .player-item input { width: 16px; height: 16px; margin: 0; }
        .scoreboard { display: flex; justify-content: space-around; align-items: center; background: #2c3e50; color: white; padding: 15px; border-radius: 18px; margin: 12px 0; }
        .score-num { font-size: 2.5em; font-weight: 900; }
        .match-card { background: #fff; border-radius: 14px; padding: 12px; margin-bottom: 10px; border: 1px solid #eee; position: relative; }
        .match-btn-group { display: flex; gap: 8px; margin-top: 10px; }
        .match-btn-group button { padding: 8px; font-size: 13px; background: #f4f4f4; color: #555; }
        .selected-a { background: var(--secondary) !important; color: white !important; }
        .selected-b { background: var(--danger) !important; color: white !important; }
        .type-badge { padding: 2px 6px; border-radius: 6px; font-weight: bold; font-size: 10px; color: white; margin-left: 6px; white-space: nowrap; }
        .type-singles { background-color: #9c27b0; }
        .type-doubles { background-color: #009688; }
        #loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.85); z-index: 10000; justify-content: center; align-items: center; font-weight: bold; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 11000; }
        .modal-content { background: white; padding: 20px; border-radius: 20px; width: 90%; max-width: 420px; position: relative; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; }
        .modal-close-x { font-size: 28px; color: #aaa; cursor: pointer; line-height: 1; }
        .confetti { position: fixed; width: 8px; height: 8px; z-index: 12000; top: -10px; animation: fall linear forwards; }
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); opacity: 0; } }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th { background: var(--primary); color: white; padding: 10px 4px; font-size: 13px; }
        td { padding: 12px 4px; text-align: center; border-bottom: 1px solid #eee; }
        .rank-num { font-weight: 800; font-size: 15px; color: #666; }
        .rank-name { font-size: 15px; font-weight: 800; }
        .rank-winrate { font-size: 16px; font-weight: 800; }
        .period-btns { display: flex; gap: 4px; margin-bottom: 8px; width: 100%; }
        .btn-p { flex: 1; padding: 8px 2px; font-size: 15px; background: #eee; color: #666; border-radius: 8px; }
        .btn-p.active { background: var(--primary); color: white; }
        .clickable-name { color: var(--secondary); text-decoration: underline; cursor: pointer; font-weight: 800; }
        .vs-detail { font-size: 11px; color: #666; display: block; margin-top: 2px; }
        .vs-detail b { font-size: 13px; color: #333; }
        .vs-detail-rate { font-size: 12px; color: var(--primary); font-weight: 800; margin-left: 2px; }
        #teamPreviewArea { text-align: center; font-size: 15px; font-weight: 800; color: #444; margin-bottom: 15px; background: #f0f0f0; padding: 10px 12px; border-radius: 12px; line-height: 1.3; }
        .team-label-a { color: var(--secondary); font-size: 13px; }
        .team-label-b { color: var(--danger); font-size: 13px; }
        .vs-divider { display: block; font-size: 11px; color: #bbb; margin: 2px 0; font-weight: normal; }
    </style>
</head>
<body>

<div id="intro-layer">
    <div class="intro-img-container">
        <img src="https://i.ibb.co/mFqWJqLt/pingbot.jpg" class="intro-img" alt="Intro Image">
    </div>
    <div class="intro-text">í´ë¼ìš°ë“œ ë°ì´í„° ë™ê¸°í™” ì¤‘...</div>
</div>

<div id="loading">ë°ì´í„° ë™ê¸°í™” ì¤‘...</div>

<div class="container">
    <div class="header-container">
        <div class="header-title">ğŸ“ PING-PONG DB PRO</div>
        <div class="header-subtitle">Designed by KS</div>
    </div>
    
    <div class="box">
        <div class="flex-row">
            <div class="input-group" style="flex: 1.5;"><label class="filter-label">ë‚ ì§œ</label><input type="date" id="matchDate" onchange="checkDateData()"></div>
            <div class="input-group"><label class="filter-label">ì‹œê°„</label><select id="matchTime" onchange="checkDateData()"><option value="lunch">ì ì‹¬</option><option value="dinner">ì €ë…</option></select></div>
            <div class="input-group"><label class="filter-label">íšŒì°¨</label><select id="matchSession" onchange="checkDateData()">
                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
                <option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
            </select></div>
        </div>
        <div id="dateStatus" style="text-align:center; font-size:11px; margin-bottom:10px; font-weight: bold;"></div>
        
        <div style="margin-top: 5px;">
            <button class="btn-blue" onclick="openModal('playerModal')">ğŸ‘¥ ì°¸ì—¬ì ì„ íƒ (<span id="selectedCountText">0</span>ëª…)</button>
            <div class="flex-row" style="margin-top:8px;">
                <div class="input-group"><label class="filter-label">ë°©ì‹</label><select id="gameMode">
                    <option value="mixed">í˜¼í•©(ë³µ/ë‹¨)</option>
                    <option value="doubles">ì „ë¶€ ë³µì‹</option>
                    <option value="singles">ì „ë¶€ ë‹¨ì‹</option>
                </select></div>
                <div class="input-group"><label class="filter-label">ìŠ¹ë¦¬ ê¸°ì¤€</label><select id="winCondition">
                    <option value="1">ë‹¨íŒ!</option>
                    <option value="3">3íŒ 2ì„ ìŠ¹</option>
                    <option value="5">5íŒ 3ì„ ìŠ¹</option>
                    <option value="7">7íŒ 4ì„ ìŠ¹</option>
                    <option value="9">9íŒ 5ì„ ìŠ¹</option>
                    <option value="11">11íŒ 6ì„ ìŠ¹</option>
                </select></div>
            </div>
            <div class="switch-container">
                <div id="balance_tight" class="switch-btn active" onclick="setBalanceMode('tight')">âš–ï¸ ë°•ë¹™(ì‹¤ë ¥ìˆœ)</div>
                <div id="balance_random" class="switch-btn" onclick="setBalanceMode('random')">ğŸ² ìš´ë¹¨(ëœë¤)</div>
            </div>
            <button class="btn-orange" onclick="handleSmartStart()">ğŸš€ ìƒˆ ëŒ€ì§„í‘œ ìƒì„±</button>
        </div>
    </div>

    <div id="matchArea" style="display:none;">
        <div class="scoreboard">
            <div style="text-align:center;"><div id="scoreA" class="score-num" style="color:#64b5f6;">0</div><div style="font-size:11px;">TEAM A</div></div>
            <div style="font-size:1.5em; opacity:0.3;">VS</div>
            <div style="text-align:center;"><div id="scoreB" class="score-num" style="color:#f28b82;">0</div><div style="font-size:11px;">TEAM B</div></div>
        </div>
        <div id="teamPreviewArea"></div>
        <div id="lineupArea"></div>
        <button id="saveBtn" class="btn-blue" style="background:var(--primary); margin-top:5px;" onclick="handleManualSave()">ğŸ ê²½ê¸° ê²°ê³¼ ìµœì¢… ì €ì¥</button>
    </div>

    <div class="box">
        <h3 style="text-align:center; margin-top:0; font-size:15px; color:#444;">ğŸ“Š ë­í‚¹ í†µê³„ (ìŠ¹ë¥ ìˆœ)</h3>
        <div class="period-btns">
            <button class="btn-p active" onclick="setQuickPeriod(0, this)">ì „ì²´</button>
            <button class="btn-p" onclick="setQuickPeriod(1, this)">1ê°œì›”</button>
            <button class="btn-p" onclick="setQuickPeriod(2, this)">2ê°œì›”</button>
            <button class="btn-p" onclick="setQuickPeriod(3, this)">3ê°œì›”</button>
        </div>
        <div class="flex-row">
            <div class="input-group"><label class="filter-label">ì‹œì‘ì¼</label><input type="date" id="statsStart" onchange="updateUI()"></div>
            <div class="input-group"><label class="filter-label">ì¢…ë£Œì¼</label><input type="date" id="statsEnd" onchange="updateUI()"></div>
        </div>
        <div id="rankingTableArea"></div>
        <button class="btn-red" onclick="resetDatabase()">âš ï¸ ë°ì´í„° ì´ˆê¸°í™”</button>
    </div>
</div>

<div id="playerModal" class="modal-overlay" onclick="closeModalOnOuterClick(event, 'playerModal')">
    <div class="modal-content">
        <div class="modal-header">
            <span style="font-weight: 800; font-size: 16px;">ì°¸ì—¬ì ì„ íƒ</span>
            <span class="modal-close-x" onclick="closeModal('playerModal')">Ã—</span>
        </div>
        <div id="playerGrid" class="player-grid"></div>
        <button class="btn-blue" style="margin-top:15px;" onclick="closeModal('playerModal')">ì„ íƒ ì™„ë£Œ</button>
    </div>
</div>

<div id="recordModal" class="modal-overlay" onclick="closeModalOnOuterClick(event, 'recordModal')">
    <div class="modal-content">
        <div class="modal-header">
            <span id="recordModalTitle" style="font-weight: 800; font-size: 16px;">ìƒëŒ€ ì „ì </span>
            <span class="modal-close-x" onclick="closeModal('recordModal')">Ã—</span>
        </div>
        <div id="recordTableArea"></div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzTImCgYtXbc4yN3VSNahYj6MKi9c36GZkF7rt8ofkE8asQWd95deMk05D8rHJMc06v/exec"; 
    const fixedList = ["ê¹€ê¸°í˜‘", "ê¹€í•™ê¸°", "ê¹€í˜„ì§„", "ì´ê²½ìƒ", "ì´ëª…ì² ", "ì´ì£¼í•­", "ì´ì¤€í˜¸", "ì´ì§„í–‰", "ê¹€ìš©ë²”", "ì´ì„í˜„", "ì¡°ì»¤1", "ì¡°ì»¤2"];
    let db = { matchHistory: {} };
    let currentMatchData = null;
    let currentBalanceMode = 'tight';
    let isAlreadySaved = false;

    window.onload = function() {
        // ì¸íŠ¸ë¡œ 2ì´ˆ ë…¸ì¶œ í›„ í˜ì´ë“œ ì•„ì›ƒ
        setTimeout(() => {
            const intro = document.getElementById('intro-layer');
            intro.style.opacity = '0';
            setTimeout(() => { intro.style.display = 'none'; }, 800);
        }, 2000);

        const today = new Date(Date.now() - new Date().getTimezoneOffset() * 60000).toISOString().split('T')[0];
        document.getElementById('matchDate').value = today;
        document.getElementById('statsEnd').value = today;
        initPlayerList(); syncWithCloud();
    };

    function setBalanceMode(mode) { currentBalanceMode = mode; document.getElementById('balance_tight').classList.toggle('active', mode === 'tight'); document.getElementById('balance_random').classList.toggle('active', mode === 'random'); }
    function initPlayerList() {
        const grid = document.getElementById('playerGrid'); grid.innerHTML = "";
        fixedList.forEach(name => {
            const div = document.createElement('div'); div.className = "player-item";
            div.innerHTML = `<input type="checkbox" name="player" value="${name}"> <span>${name}</span>`;
            div.onclick = function(e) { const cb = this.querySelector('input'); if(e.target !== cb) cb.checked = !cb.checked; updateCount(); };
            grid.appendChild(div);
        });
    }
    function updateCount() { document.getElementById('selectedCountText').innerText = document.querySelectorAll('input[name="player"]:checked').length; }
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function closeModalOnOuterClick(e, id) { if(e.target.id === id) closeModal(id); }
    function getCurrentKey() { return `${document.getElementById('matchDate').value}_${document.getElementById('matchTime').value}_s${document.getElementById('matchSession').value}`; }

    function checkDateData() {
        if(!db.matchHistory) return;
        const key = getCurrentKey();
        const matchData = db.matchHistory[key];
        if(matchData) {
            document.getElementById('dateStatus').innerHTML = "âœ… ê¸°ì¡´ ê¸°ë¡ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.";
            document.getElementById('dateStatus').style.color = "var(--secondary)";
            currentMatchData = JSON.parse(JSON.stringify(matchData));
            document.getElementById('matchArea').style.display = 'block';
            updateTeamPreview(currentMatchData.teams.a, currentMatchData.teams.b);
            isAlreadySaved = true; render(); 
        } else {
            document.getElementById('dateStatus').innerHTML = "âšª ê¸°ë¡ ì—†ìŒ (ìƒˆ ëŒ€ì§„ ìƒì„± ê°€ëŠ¥)";
            document.getElementById('dateStatus').style.color = "#ccc";
            document.getElementById('matchArea').style.display = 'none';
            isAlreadySaved = false;
        }
    }

    function updateTeamPreview(a, b) {
        const area = document.getElementById('teamPreviewArea');
        area.innerHTML = `<span class="team-label-a">TEAM A</span><br>${a.join(', ')}<br><span class="vs-divider">â€” VS â€”</span><span class="team-label-b">TEAM B</span><br>${b.join(', ')}`;
    }

    async function syncWithCloud() {
        document.getElementById('loading').style.display = 'flex';
        try { 
            const response = await fetch(`${API_URL}?t=${Date.now()}`);
            const text = await response.text(); 
            if(text && text !== "EMPTY") { db = JSON.parse(text); if(!db.matchHistory) db.matchHistory = {}; }
            updateUI(); checkDateData();
        } catch(e) { console.error(e); } finally { document.getElementById('loading').style.display = 'none'; }
    }

    function handleSmartStart() {
        const d = document.getElementById('matchDate').value, t = document.getElementById('matchTime').value, s = document.getElementById('matchSession').value;
        const key = `${d}_${t}_s${s}`;
        if (db.matchHistory && db.matchHistory[key]) {
            let nextS = -1;
            for (let i = 1; i <= 10; i++) { if (!db.matchHistory[`${d}_${t}_s${i}`]) { nextS = i; break; } }
            if (nextS === -1) { alert("ë‹¤ìŒ íšŒì°¨ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
            if (confirm(`ì´ë¯¸ ê¸°ë¡ì´ ìˆìŠµë‹ˆë‹¤. ${nextS}íšŒì°¨ë¡œ ìƒì„±í• ê¹Œìš”?`)) { document.getElementById('matchSession').value = nextS; isAlreadySaved = false; startMatching(); }
        } else { isAlreadySaved = false; startMatching(); }
    }

    function getWinRateMap() {
        let stats = {}; fixedList.forEach(n => stats[n] = { win: 0, total: 0 });
        if(db.matchHistory) {
            Object.values(db.matchHistory).forEach(m => {
                if(!m || !m.results || !m.lineups) return;
                m.lineups.forEach(l => {
                    const res = m.results[l.id]; if(!res) return;
                    const win = res === 'A' ? l.pA : l.pB, lose = res === 'A' ? l.pB : l.pA;
                    win.forEach(p => { if(stats[p]) { stats[p].win++; stats[p].total++; } });
                    lose.forEach(p => { if(stats[p]) stats[p].total++; });
                });
            });
        }
        return stats;
    }

    function startMatching() {
        const selected = Array.from(document.querySelectorAll('input[name="player"]:checked')).map(c => c.value);
        if(selected.length < 2) { alert("2ëª… ì´ìƒ ì„ íƒí•˜ì„¸ìš”!"); return; }
        const stats = getWinRateMap();
        const wrMap = {};
        fixedList.forEach(n => wrMap[n] = (stats[n].total === 0) ? 0.5 : (stats[n].win / stats[n].total));

        let a = [], b = [];
        if (currentBalanceMode === 'tight') {
            const sorted = [...selected].sort((p1, p2) => wrMap[p2] - wrMap[p1]);
            sorted.forEach((p, i) => (Math.floor(i/2)%2===0 ? (i%2===0?a:b) : (i%2===0?b:a)).push(p));
        } else {
            const shuffled = [...selected].sort(() => Math.random() - 0.5);
            shuffled.forEach((p, i) => (i < shuffled.length / 2 ? a : b).push(p));
        }

        const wc = parseInt(document.getElementById('winCondition').value) || 1, mode = document.getElementById('gameMode').value;
        currentMatchData = { teams:{a, b}, lineups:[], results:{}, config:{winCon:wc} };

        for(let i=1; i<=wc; i++) {
            let isD = (mode === 'doubles' || (mode === 'mixed' && i % 2 !== 0));
            if (a.length < 2 || b.length < 2) isD = false;
            if(isD) {
                let pA = a.sort(()=>.5-Math.random()).slice(0,2), pB = b.sort(()=>.5-Math.random()).slice(0,2);
                currentMatchData.lineups.push({ id:i, pA, pB, type:'ë³µì‹' });
            } else {
                let pa = a[Math.floor(Math.random()*a.length)], pb = b[Math.floor(Math.random()*b.length)];
                currentMatchData.lineups.push({ id:i, pA:[pa], pB:[pb], type:'ë‹¨ì‹' });
            }
        }
        document.getElementById('matchArea').style.display = 'block'; updateTeamPreview(a, b); render();
    }

    function render() {
        if(!currentMatchData || !currentMatchData.lineups) return;
        const area = document.getElementById('lineupArea'); area.innerHTML = "";
        let wA=0, wB=0;
        Object.values(currentMatchData.results).forEach(v => (v==='A'?wA++:(v==='B'?wB++:0)));
        document.getElementById('scoreA').innerText = wA; document.getElementById('scoreB').innerText = wB;

        currentMatchData.lineups.forEach(m => {
            const win = currentMatchData.results[m.id];
            const div = document.createElement('div'); div.className = 'match-card';
            div.innerHTML = `<small>#${m.id}</small><span class=\"type-badge ${m.type==='ë‹¨ì‹'?'type-singles':'type-doubles'}\">${m.type}</span>
                <div style=\"display:flex; justify-content:space-between; margin:8px 0; font-weight:bold;\">
                    <div style=\"flex:1;\">${m.pA.join(', ')}</div><div style=\"color:#bbb;\">VS</div><div style=\"flex:1; text-align:right;\">${m.pB.join(', ')}</div>
                </div>
                <div class=\"match-btn-group\"><button class=\"${win==='A'?'selected-a':''}\" onclick=\"record(${m.id},'A')\">A ìŠ¹</button><button class=\"${win==='B'?'selected-b':''}\" onclick=\"record(${m.id},'B')\">B ìŠ¹</button></div>`;
            area.appendChild(div);
        });
    }

    function record(id, w) {
        currentMatchData.results[id] = (currentMatchData.results[id] === w) ? null : w;
        render();
        let a=0, b=0, target = Math.ceil(currentMatchData.config.winCon/2);
        Object.values(currentMatchData.results).forEach(v=>(v==='A'?a++:(v==='B'?b++:0)));
        if(a>=target || b>=target) { triggerConfetti(); setTimeout(() => { if(confirm(`${a>=target?'A':'B'} ìŠ¹ë¦¬! ì €ì¥í• ê¹Œìš”?`)) saveToCloud(true); }, 500); }
    }

    async function saveToCloud(isAuto = false) {
        const key = getCurrentKey(); document.getElementById('loading').style.display = 'flex';
        db.matchHistory[key] = currentMatchData;
        try { 
            await fetch(API_URL, {method: "POST", body: JSON.stringify({type: "SAVE", db: db}), mode: 'no-cors'});
            isAlreadySaved = true; if(!isAuto) alert("ì €ì¥ë¨"); await syncWithCloud();
        } catch(e) { alert("ì €ì¥ ì‹¤íŒ¨"); } finally { document.getElementById('loading').style.display = 'none'; }
    }

    function handleManualSave() { if(confirm("ê²°ê³¼ë¥¼ ìµœì¢… ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) saveToCloud(); }

    function showVersusStats(name) {
        document.getElementById('recordModalTitle').innerText = `ğŸ”¥ ${name} vs ìƒëŒ€ ì „ì `;
        let vsStats = {}; 
        const start = document.getElementById('statsStart').value, end = document.getElementById('statsEnd').value;
        Object.keys(db.matchHistory).forEach(key => {
            const dStr = key.substring(0, 10); if((start && dStr < start) || (end && dStr > end)) return;
            const m = db.matchHistory[key]; m.lineups.forEach(l => {
                const res = m.results[l.id]; if(!res) return;
                const isA = l.pA.includes(name), isB = l.pB.includes(name);
                if(isA || isB) {
                    const oppTeam = isA ? l.pB : l.pA, won = (isA && res === 'A') || (isB && res === 'B');
                    oppTeam.forEach(opp => { if(!vsStats[opp]) vsStats[opp]={w:0,t:0}; vsStats[opp].t++; if(won) vsStats[opp].w++; });
                }
            });
        });
        let html = `<table><tr><th>ìƒëŒ€</th><th>ê²Œì„</th><th>ìŠ¹ë¥ </th></tr>`;
        Object.entries(vsStats).sort((a,b)=>b[1].t-a[1].t).forEach(([n,d]) => {
            const rate = d.t === 0 ? 0 : Math.round(d.w/d.t*100);
            html += `<tr><td><b>${n}</b></td><td>${d.t}</td><td><span class=\"vs-detail-rate\">${rate}%</span> (${d.w}ìŠ¹)</td></tr>`;
        });
        document.getElementById('recordTableArea').innerHTML = html + "</table>"; openModal('recordModal');
    }

    function updateUI() {
        let stats = {}; fixedList.forEach(n => stats[n] = { win: 0, total: 0 });
        const start = document.getElementById('statsStart').value, end = document.getElementById('statsEnd').value;
        Object.keys(db.matchHistory).forEach(key => {
            const dStr = key.substring(0, 10); if((start && dStr < start) || (end && dStr > end)) return;
            const m = db.matchHistory[key]; m.lineups.forEach(l => {
                const res = m.results[l.id]; if(!res) return;
                const win = res === 'A' ? l.pA : l.pB, lose = res === 'A' ? l.pB : l.pA;
                win.forEach(p => { if(stats[p]) { stats[p].win++; stats[p].total++; } });
                lose.forEach(p => { if(stats[p]) stats[p].total++; });
            });
        });
        let sorted = Object.entries(stats).filter(x=>x[1].total>0).sort((a,b) => (b[1].win/b[1].total) - (a[1].win/a[1].total));
        let html = `<table><tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th>ê²Œì„</th><th>ìŠ¹ìˆ˜</th><th>ìŠ¹ë¥ </th></tr>`;
        sorted.forEach(([n, d], i) => {
            html += `<tr><td class=\"rank-num\">${i+1}</td>
                <td><b class=\"clickable-name\" onclick=\"showVersusStats('${n}')\">${n}</b></td>
                <td style=\"font-size:14px;\">${d.total}</td>
                <td style=\"font-size:14px;\">${d.win}</td>
                <td><b class=\"rank-winrate\" style=\"color:var(--primary)\">${((d.win/d.total)*100).toFixed(1)}%</b></td>
            </tr>`; 
        });
        document.getElementById('rankingTableArea').innerHTML = sorted.length ? html + "</table>" : "<p style='text-align:center;'>ê¸°ë¡ ì—†ìŒ</p>";
    }

    function setQuickPeriod(m, btn) {
        document.querySelectorAll('.btn-p').forEach(b => b.classList.remove('active')); btn.classList.add('active');
        const start = new Date(); if(m === 0) document.getElementById('statsStart').value = "";
        else { start.setMonth(start.getMonth() - m); document.getElementById('statsStart').value = start.toISOString().split('T')[0]; }
        updateUI();
    }

    function triggerConfetti() {
        for (let i = 0; i < 50; i++) {
            const c = document.createElement('div'); c.className = 'confetti';
            c.style.left = Math.random() * 100 + 'vw'; c.style.backgroundColor = `hsl(${Math.random()*360}, 70%, 50%)`;
            c.style.animationDuration = (Math.random()*3+2)+'s'; document.body.appendChild(c);
            setTimeout(() => c.remove(), 5000);
        }
    }

    async function resetDatabase() { if (prompt("ê´€ë¦¬ì ì•”í˜¸?") === "7640" && confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?")) { db = { matchHistory: {} }; saveToCloud(); } }
    if ("serviceWorker" in navigator) { navigator.serviceWorker.register("./service-worker.js"); }
</script>
</body>
</html>
